% Autogenerated translation of doc.md by Texpad
% To stop this file being overwritten during the typeset process, please move or remove this header

\documentclass[12pt]{book}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,left=.5in,right=.5in,top=.3in,bottom=0.3in]{geometry}
\setlength\parindent{0pt}
\setlength{\parskip}{\baselineskip}
\renewcommand*\familydefault{\sfdefault}
\usepackage{hyperref}
\pagestyle{plain}
\usepackage{standalone}
\usepackage{times}
\usepackage{float}
\usepackage{amsmath}
\usepackage{graphicx}  
\begin{document}

\chapter*{Documentation: Policy synthesis via formal abstraction}

\section*{Do abstraction of LTI system}
Define LTI system as 
 \begin{align} \label{eq:LTI} \begin{aligned}
x_{k+1}&=A x_{k} + B u_k+ w_k\\
y_k&=Cx_k+Du_k+v_k\end{aligned} \end{align}
with 
\begin{itemize}
	\item $x$ state of size $n$
	\item $u$ input of size $m$
	\item $A$ matrix of size $n\times n$
	\item $B$ matrix of size $n\times m$
	\item $y$ the output (used to compare accuracy)
	\item $C$ output matrix of size $q\times n$
	\item $D$ matrix currently assumed to be zero
\end{itemize}
\begin{align}\label{eq:transition}
x_+- \tilde x_{+}=(A+BK)(x- \tilde x)+\mathbf r 
\end{align}
with \begin{itemize}
	\item $\mathbf r$ in a polytope, i.e., $\mathbf r\in \mathcal V(r_i) $, the polytope generated from vertices $r_i$.
\end{itemize}

Consider a set defined as 
\begin{align}
\mathcal R:= \{(\tilde x,x)\mid (x- \tilde x)^TM (x- \tilde x)\leq \epsilon\}	
\end{align} 

\noindent\textbf{Objective:} Design $M$, $K$ and $\epsilon$ such that 
if $(\tilde x,x)\in\mathcal R$ then also 
\[\{(x_+- \tilde x_{+})| \mbox{ s.t. \eqref{eq:transition} }\forall \mathbf r\in \mathcal V(r_i)\}\subseteq \mathcal R .\]
More over for all $(\tilde x,x)\in \mathcal R$ it should hold that $d(\tilde y,y)\leq \epsilon$. The latter can be expressed as $C^TC\preceq M$.
The former can be written with matrix  inequalities as
\begin{align*}
	(x_+- \tilde x_+)^TM (x_+- \tilde x_+)\leq \epsilon
\\
	((A+BK)(x- \tilde x)+\mathbf r )^TM ((A+BK)(x- \tilde x)+\mathbf r )\leq \epsilon	
\end{align*}

Hence we get something of this form
\[ (x- \tilde x)^TM (x- \tilde x)\leq \epsilon^2\implies 	((A+BK)(x- \tilde x)+\mathbf r )^TM ((A+BK)(x- \tilde x)+\mathbf r )\leq \epsilon^2	\]

\fbox{
\noindent\begin{minipage}[b]{.8\textwidth}
	\noindent\textbf{S-procedure}\footnote{\url{https://en.wikipedia.org/wiki/S-procedure}}\\
The implications
	\begin{align}
		x^T F_1 x+ 2g_1^Tx+h_1\leq 0\implies x^T F_2 x+ 2g_2^Tx+h_2\leq 0
	\end{align}
	holds if and only if there exists $\lambda\geq 0$ such that
	\begin{align}
		\lambda \begin{bmatrix}
		F_1& g_1\\g_1^T & h_1	
		\end{bmatrix}-\begin{bmatrix}
		F_2& g_2\\g_2^T & h_2
		\end{bmatrix} \succeq 0
	\end{align}
%	This is equivalent to $\beta\geq 0$ 
%		\begin{align}
%		 \begin{bmatrix}
%		F_1& g_1\\g_1^T & h_1	
%		\end{bmatrix}-\beta\begin{bmatrix}
%		F_2& g_2\\g_2^T & h_2
%		\end{bmatrix} \succeq 0
%	\end{align}
\end{minipage}
}


Using the S-procedure  we get
\begin{align}	
(x- \tilde x)^T (A+BK)^TM (A+BK)(x- \tilde x)
+2 \mathbf r^T M(A+BK)(x- \tilde x) +  \mathbf r^T M\mathbf r
%
\leq \epsilon^2	\\
	\lambda\begin{bmatrix}
		M&0\\0&-\epsilon^2
	\end{bmatrix}-  \begin{bmatrix}
		(A+BK)^TM (A+BK) &(A+BK)^T M  \mathbf r\\ \mathbf r^T M(A+BK)& \mathbf r^T M\mathbf r-\epsilon^2
	\end{bmatrix} \succeq 0
	\\
	\begin{bmatrix}
		\lambda M- ((A+BK)^TM (A+BK))&- (A+BK)^T M  \mathbf r\\-   \mathbf r^T M(A+BK) &(1-\lambda )\epsilon^2-  \mathbf r^T M\mathbf  r
	\end{bmatrix} \succeq 0\\
		\begin{bmatrix}
		\lambda M&0 \\0 &(1-\lambda )\epsilon^2
	\end{bmatrix} -	\begin{bmatrix}
	  ((A+BK)^TM (A+BK))& (A+BK)^T M  \mathbf r\\   \mathbf r^T M(A+BK) &  \mathbf r^T M\mathbf  r
	\end{bmatrix}  \succeq 0\\
		\begin{bmatrix}
		\lambda M&0 \\0 &(1-\lambda )\epsilon^2
	\end{bmatrix} - 	\begin{bmatrix}
 		  (A+BK)^TM\\\mathbf r^T M
 	\end{bmatrix}M^{-1}
	\begin{bmatrix}
 		  (A+BK)^TM\\\mathbf r^T M
 	\end{bmatrix}^T \succeq 0\\
 	\begin{bmatrix}
 		\lambda M&0 				& 	(A+BK)^TM		\\
 		0 &(1-\lambda )\epsilon^2& \mathbf r^T M	\\
 		M (A+BK)& M \mathbf r& M
 	\end{bmatrix} \succeq 0\\
 		\begin{bmatrix}
 		\lambda M^{-1}&0 				& M^{-1}	(A+BK)^T 		\\
 		0 &(1-\lambda )\epsilon^2& \mathbf r^T  	\\
 	  (A+BK)M^{-1}& \mathbf r& M^{-1} 
 	\end{bmatrix} \succeq 0\\
 		\begin{bmatrix}
 		\lambda M^{-1}&0 				& M^{-1}	(A+BK)^T 		\\
 		0 &(1-\lambda )\epsilon^2&  r_i^T  	\\
 	  (A+BK)M^{-1}&  r_i & M^{-1} 
 	\end{bmatrix} \succeq 0,\  \forall r_i \\ 
\end{align}
Remark that this implies that $1-\lambda \geq0$ hence $1\geq\lambda\geq0 $.  And remark that 

The objective to find a minimal $\epsilon$ can be expressed as follows
\begin{align}
\mathbf{Objective:    }& \min_{M_{inv}, L} \epsilon^2\\
&	\begin{bmatrix}
 		\lambda M_{inv}&0 				& 	M_{inv}A^T+L^TB^T 		\\
 		0 &(1-\lambda )\epsilon^2&   r_i^T  	\\
 	  AM_{inv}+BL& r_i& M_{inv} \\
 	\end{bmatrix}\succeq0\\
&  \begin{bmatrix}
  	M_{inv} & M_{inv}C^T\\
  	CM_{inv} & I
  \end{bmatrix} \succeq0
\end{align}
with $LM=K$ and $M^{-1}=M_{inv}$.
 
\end{document}
